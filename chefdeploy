#!/bin/zsh
# =========================================================
# chefdeploy
# Build production bundle and deploy to Cloudflare Pages
# =========================================================

# Navigate to project directory
cd ~/Chef || {
    echo "âŒ Failed to navigate to project directory"
    exit 1
}

# Stage any local changes
echo "ğŸ“‚ Staging local changes..."
git add .

# Commit changes with timestamp
git commit -m "Local update $(date '+%Y-%m-%d %H:%M:%S')" 2>/dev/null || {
    echo "â„¹ï¸ No changes to commit"
}

# Pull latest changes from GitHub main branch
echo "ğŸ”„ Pulling latest changes from GitHub..."
git pull origin main --rebase || {
    echo "âš ï¸ Git pull failed. Please resolve conflicts manually."
}

# Install dependencies
echo "ğŸ“¦ Installing dependencies..."
npm install

# Build production bundle
echo "ğŸ“¦ Building production bundle..."
npm run build || {
    echo "âŒ Production build failed"
    exit 1
}

# Deploy to Cloudflare Pages
echo "â˜ï¸ Deploying to Cloudflare Pages..."
# Use 'pages deploy' if using latest Wrangler
wrangler pages deploy build || {
    echo "âŒ Deployment failed"
    exit 1
}

# Open the live site
LIVE_URL="https://chefs2table-prod.pages.dev"
echo "ğŸŒ Opening live site: $LIVE_URL"
open $LIVE_URL

echo "âœ… Deployment complete!"

