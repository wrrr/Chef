#!/bin/bash

# =====================================
# 🧑‍🍳 CHEF CONTROL PANEL — PRO KITCHEN EDITION
# =====================================

# -----------------------------
# Helper: simple animated dots
# -----------------------------
progress_dots() {
  for i in {1..3}; do
    echo -n "."
    sleep 0.4
  done
  echo ""
}

# -----------------------------
# Helper: auto-repair node_modules
# -----------------------------
auto_repair() {
  echo "🔍 Checking project dependencies..."
  if [ ! -d "node_modules" ] || [ ! -f "node_modules/react/package.json" ]; then
    echo "⚙️  Missing dependencies detected. Running npm install"
    progress_dots
    npm install > /dev/null 2>&1
    echo "✅ Dependencies installed!"
  else
    echo "✅ All dependencies look good!"
  fi
}

# -----------------------------
# Main menu loop
# -----------------------------
while true; do
  clear
  echo "====================================="
  echo "1️⃣  🚀 Launch Website Preview (Local)"
  echo "2️⃣  📦 Prepare Website for Launch (Build)"
  echo "3️⃣  🌍 Publish Live Website (Cloudflare)"
  echo "4️⃣  🧹 Deep Clean & Reset Project"
  echo "5️⃣  🔄 Sync Local Repository with GitHub"
  echo "6️⃣  🔁 Sync with Builder.io"
  echo "====================================="
  read -p "Enter 1, 2, 3, 4, 5, or 6: " choice
  echo ""

  case $choice in
    1)
      echo "🚀 Launching local preview..."
      auto_repair
      npm start
      read -p "Press Enter to return to menu..."
      ;;
    2)
      echo "📦 Building production version..."
      auto_repair
      npm run build
      echo "✅ Build complete! Files in /build"
      read -p "Press Enter to return to menu..."
      ;;
    3)
      echo "🌍 Publishing website via Cloudflare..."
      auto_repair
      npm run build
      echo "🚀 Deploying to Cloudflare Pages..."
      wrangler pages deploy build
      if [ $? -eq 0 ]; then
        echo "✅ Published successfully!"
      else
        echo "❌ Deployment failed."
      fi
      read -p "Press Enter to return to menu..."
      ;;
    4)
      echo "🧹 Resetting project..."
      rm -rf node_modules build package-lock.json
      echo "♻️  Reinstalling clean environment..."
      npm install
      echo "✅ Project reset complete."
      read -p "Press Enter to return to menu..."
      ;;
    5)
      echo "🔄 Syncing local repository with GitHub..."
      
      # Check for unfinished merge
      if [ -f ".git/MERGE_HEAD" ]; then
        echo "❗ There is an unfinished merge. Resolve it manually first."
        read -p "Press Enter to return to menu..."
        continue
      fi

      # Check for unstaged changes
      if ! git diff --quiet; then
        echo "❗ You have unstaged or uncommitted changes."
        echo "1️⃣ Commit changes"
        echo "2️⃣ Stash changes"
        echo "3️⃣ Cancel sync"
        read -p "Enter 1, 2, or 3: " action
        case $action in
          1)
            read -p "Enter commit message: " msg
            git add .
            git commit -m "$msg"
            ;;
          2)
            git stash
            ;;
          3)
            echo "❌ Sync canceled."
            read -p "Press Enter to return to menu..."
            continue
            ;;
          *)
            echo "❌ Invalid choice. Canceling."
            read -p "Press Enter to return to menu..."
            continue
            ;;
        esac
      fi

      # Pull and push
      git config pull.rebase false
      git pull --rebase origin main || {
        echo "❌ Pull failed. Resolve conflicts manually."
        read -p "Press Enter to return to menu..."
        continue
      }
      git push origin main || {
        echo "❌ Push failed. Make sure the branch is up-to-date."
        read -p "Press Enter to return to menu..."
        continue
      }

      echo "✅ GitHub sync complete!"

      # -----------------------------
      # Auto-refresh Builder.io
      # -----------------------------
      echo "🔁 Triggering Builder.io fetch..."
      BUILDER_PROJECT_API_KEY="YOUR_BUILDER_PROJECT_API_KEY"
      if [ -z "$BUILDER_PROJECT_API_KEY" ]; then
        echo "❌ Builder.io API key not set. Skipping Builder.io sync."
      else
        curl -X POST "https://builder.io/api/v1/publish/${BUILDER_PROJECT_API_KEY}?branch=main" \
          -H "Content-Type: application/json" \
          -d '{"publish":true}'
        if [ $? -eq 0 ]; then
          echo "✅ Builder.io fetch triggered!"
        else
          echo "❌ Failed to trigger Builder.io."
        fi
      fi

      read -p "Press Enter to return to menu..."
      ;;

    6)
      echo "🔁 Manual Builder.io sync..."
      read -p "Press Enter to return to menu..."
      ;;

    *)
      echo "❌ Invalid option. Try again."
      sleep 1
      ;;
  esac
done
