#!/bin/bash

# =====================================
# ğŸ§‘â€ğŸ³ CHEF CONTROL PANEL â€” PRO KITCHEN EDITION
# =====================================

# -----------------------------
# Helper: simple animated dots
# -----------------------------
progress_dots() {
  for i in {1..3}; do
    echo -n "."
    sleep 0.4
  done
  echo ""
}

# -----------------------------
# Helper: auto-repair node_modules
# -----------------------------
auto_repair() {
  echo "ğŸ” Checking project dependencies..."
  if [ ! -d "node_modules" ] || [ ! -f "node_modules/react/package.json" ]; then
    echo "âš™ï¸  Missing dependencies detected. Running npm install"
    progress_dots
    npm install > /dev/null 2>&1
    echo "âœ… Dependencies installed!"
  else
    echo "âœ… All dependencies look good!"
  fi
}

# -----------------------------
# Main menu loop
# -----------------------------
while true; do
  clear
  echo "====================================="
  echo "1ï¸âƒ£  ğŸš€ Launch Website Preview (Local)"
  echo "2ï¸âƒ£  ğŸ“¦ Prepare Website for Launch (Build)"
  echo "3ï¸âƒ£  ğŸŒ Publish Live Website (Cloudflare)"
  echo "4ï¸âƒ£  ğŸ§¹ Deep Clean & Reset Project"
  echo "5ï¸âƒ£  ğŸ”„ Sync Local Repository with GitHub"
  echo "6ï¸âƒ£  ğŸ” Sync with Builder.io"
  echo "====================================="
  read -p "Enter 1, 2, 3, 4, 5, or 6: " choice
  echo ""

  # Force lowercase (compatible with older macOS Bash)
  choice=$(echo "$choice" | tr '[:upper:]' '[:lower:]')

  case $choice in
    1)
      echo "ğŸš€ Launching local preview..."
      auto_repair
      npm start
      read -p "Press Enter to return to menu..."
      ;;

    2)
      echo "ğŸ“¦ Building production version..."
      auto_repair
      npm run build
      echo "âœ… Build complete! Files in /build"
      read -p "Press Enter to return to menu..."
      ;;

    3)
      echo "ğŸŒ Publishing website via Cloudflare..."
      auto_repair
      npm run build
      echo "ğŸš€ Deploying to Cloudflare Pages..."
      wrangler pages deploy build
      if [ $? -eq 0 ]; then
        echo "âœ… Published successfully!"
      else
        echo "âŒ Deployment failed."
      fi
      read -p "Press Enter to return to menu..."
      ;;

    4)
      echo "ğŸ§¹ Resetting project..."
      rm -rf node_modules build package-lock.json
      echo "â™»ï¸  Reinstalling clean environment..."
      npm install
      echo "âœ… Project reset complete."
      read -p "Press Enter to return to menu..."
      ;;

    5)
      echo "ğŸ”„ Syncing local repository with GitHub..."
      if ! git diff --quiet; then
        echo "â— You have unstaged changes."
        echo "1ï¸âƒ£ Commit changes"
        echo "2ï¸âƒ£ Stash changes"
        echo "3ï¸âƒ£ Cancel"
        read -p "Enter 1, 2, or 3: " action
        case $action in
          1)
            read -p "Enter commit message: " msg
            git add .
            git commit -m "$msg"
            ;;
          2)
            git stash
            ;;
          3)
            echo "âŒ Sync canceled."
            read -p "Press Enter to return to menu..."
            continue
            ;;
          *)
            echo "âŒ Invalid choice. Canceling."
            read -p "Press Enter to return to menu..."
            continue
            ;;
        esac
      fi
      git config pull.rebase false
      git pull origin main
      git push origin main
      echo "âœ… Sync complete!"
      read -p "Press Enter to return to menu..."
      ;;

    6)
      echo "ğŸ” Syncing with Builder.io..."
      # Add your Builder.io sync commands here
      echo "âœ… Builder.io sync complete!"
      read -p "Press Enter to return to menu..."
      ;;

    *)
      echo "âŒ Invalid option. Try again."
      sleep 1
      ;;
  esac
done
