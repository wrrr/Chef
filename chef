#!/bin/bash

# =====================================
# ğŸ§‘â€ğŸ³ CHEF CONTROL PANEL â€” PRO KITCHEN EDITION
# =====================================

# Helper: simple animated dots
progress_dots() {
  for i in {1..3}; do
    echo -n "."
    sleep 0.5
  done
  echo ""
}

# Helper: auto-repair node_modules if broken or missing
auto_repair() {
  echo "ğŸ” Checking project dependencies..."
  if [ ! -d "node_modules" ] || [ ! -f "node_modules/react/package.json" ]; then
    echo "âš™ï¸  Missing dependencies detected. Running npm install"
    progress_dots
    npm install > /dev/null 2>&1
    if [ $? -eq 0 ]; then
      echo "âœ… All dependencies installed successfully!"
    else
      echo "âŒ Failed to install dependencies. Check npm logs for details."
      exit 1
    fi
  else
    echo "âœ… All dependencies look good!"
  fi
}

# Helper: section separator
separator() {
  echo ""
  echo "====================================="
}

# --- Display Menu ---
clear
separator
echo "        ğŸ§‘â€ğŸ³ CHEF CONTROL PANEL       "
separator
echo ""
echo "1) ğŸš§ Launch Website Preview (Local)"
echo "2) ğŸ“¦ Prepare Website for Launch (Build)"
echo "3) ğŸŒ Publish Live Website (Cloudflare)"
echo "4) ğŸ§¹ Deep Clean & Reset Project"
separator
echo ""
read -p "Enter 1, 2, 3, or 4: " choice
echo ""

# --- Main Actions ---
case "$choice" in
  1)
    echo "ğŸš€ Launching website preview locally..."
    auto_repair
    echo "ğŸ§± Starting development server"
    progress_dots
    npm start
    ;;
  2)
    echo "ğŸ—ï¸  Preparing optimized production bundle..."
    auto_repair
    echo "âš™ï¸  Building website"
    progress_dots
    npm run build
    if [ $? -eq 0 ]; then
      echo "âœ… Build completed successfully! Files are ready in /build"
    else
      echo "âŒ Build failed. Check above logs for details."
    fi
    ;;
  3)
    echo "ğŸŒ Deploying your website to Cloudflare Pages..."
    auto_repair
    echo "ğŸ§± Building project"
    progress_dots
    npm run build
    if [ $? -eq 0 ]; then
      echo "ğŸš€ Uploading build to Cloudflare"
      progress_dots
      npx wrangler pages deploy build --project-name chefs2table
      if [ $? -eq 0 ]; then
        echo "âœ… Deployment complete! ğŸŒ Your site is live."
      else
        echo "âŒ Deployment failed. Please check wrangler output above."
      fi
    else
      echo "âŒ Build failed. Deployment cancelled."
    fi
    ;;
  4)
    echo "ğŸ§¹ Performing Deep Clean & Reset..."
    echo "âš ï¸  This will remove node_modules and reinstall everything fresh."
    read -p "Continue? (y/N): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
      echo "ğŸš¿ Cleaning project"
      rm -rf node_modules package-lock.json
      progress_dots
      echo "ğŸ“¦ Reinstalling dependencies"
      npm install
      if [ $? -eq 0 ]; then
        echo "âœ… Deep Clean completed successfully!"
      else
        echo "âŒ Something went wrong during reinstall. Check npm logs."
      fi
    else
      echo "ğŸ›‘ Clean cancelled."
    fi
    ;;
  *)
    echo "âŒ Invalid selection. Please run the script again and choose 1, 2, 3, or 4."
    ;;
esac

separator
echo "ğŸ’¡ Tip: You can re-run this anytime with './chef'"
echo ""

