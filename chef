#!/bin/bash

# =====================================
# ğŸ§‘â€ğŸ³ CHEF CONTROL PANEL â€” PRO KITCHEN EDITION
# =====================================

# -----------------------------
# Helper: simple animated dots
# -----------------------------
progress_dots() {
  for i in {1..3}; do
    echo -n "."
    sleep 0.4
  done
  echo ""
}

# -----------------------------
# Helper: auto-repair node_modules
# -----------------------------
auto_repair() {
  echo "ğŸ” Checking project dependencies..."
  if [ ! -d "node_modules" ] || [ ! -f "node_modules/react/package.json" ]; then
    echo "âš™ï¸  Missing dependencies detected. Running npm install"
    progress_dots
    npm install > /dev/null 2>&1
    echo "âœ… Dependencies installed!"
  else
    echo "âœ… All dependencies look good!"
  fi
}

# -----------------------------
# Main menu loop
# -----------------------------
while true; do
  clear
  echo "====================================="
  echo "1ï¸âƒ£  ğŸš€ Launch Website Preview (Local)"
  echo "2ï¸âƒ£  ğŸ“¦ Prepare Website for Launch (Build)"
  echo "3ï¸âƒ£  ğŸŒ Publish Live Website (Cloudflare)"
  echo "4ï¸âƒ£  ğŸ§¹ Deep Clean & Reset Project"
  echo "5ï¸âƒ£  ğŸ”„ Sync Local Repository with GitHub"
  echo "6ï¸âƒ£  ğŸ” Sync with Builder.io"
  echo "====================================="
  read -p "Enter 1, 2, 3, 4, 5, or 6: " choice
  echo ""

  case $choice in
    1)
      echo "ğŸš€ Launching local preview..."
      auto_repair
      npm start
      read -p "Press Enter to return to menu..."
      ;;
    2)
      echo "ğŸ“¦ Building production version..."
      auto_repair
      npm run build
      echo "âœ… Build complete! Files in /build"
      read -p "Press Enter to return to menu..."
      ;;
    3)
      echo "ğŸŒ Publishing website via Cloudflare..."
      auto_repair
      npm run build
      echo "ğŸš€ Deploying to Cloudflare Pages..."
      wrangler pages deploy build
      if [ $? -eq 0 ]; then
        echo "âœ… Published successfully!"
      else
        echo "âŒ Deployment failed."
      fi
      read -p "Press Enter to return to menu..."
      ;;
    4)
      echo "ğŸ§¹ Resetting project..."
      rm -rf node_modules build package-lock.json
      echo "â™»ï¸  Reinstalling clean environment..."
      npm install
      echo "âœ… Project reset complete."
      read -p "Press Enter to return to menu..."
      ;;
    5)
      echo "ğŸ”„ Syncing local repository with GitHub..."
      
      # Check for unfinished merge
      if [ -f ".git/MERGE_HEAD" ]; then
        echo "â— There is an unfinished merge. Resolve it manually first."
        read -p "Press Enter to return to menu..."
        continue
      fi

      # Check for unstaged changes
      if ! git diff --quiet; then
        echo "â— You have unstaged or uncommitted changes."
        echo "1ï¸âƒ£ Commit changes"
        echo "2ï¸âƒ£ Stash changes"
        echo "3ï¸âƒ£ Cancel sync"
        read -p "Enter 1, 2, or 3: " action
        case $action in
          1)
            read -p "Enter commit message: " msg
            git add .
            git commit -m "$msg"
            ;;
          2)
            git stash
            ;;
          3)
            echo "âŒ Sync canceled."
            read -p "Press Enter to return to menu..."
            continue
            ;;
          *)
            echo "âŒ Invalid choice. Canceling."
            read -p "Press Enter to return to menu..."
            continue
            ;;
        esac
      fi

      # Pull and push
      git config pull.rebase false
      git pull --rebase origin main || {
        echo "âŒ Pull failed. Resolve conflicts manually."
        read -p "Press Enter to return to menu..."
        continue
      }
      git push origin main || {
        echo "âŒ Push failed. Make sure the branch is up-to-date."
        read -p "Press Enter to return to menu..."
        continue
      }

      echo "âœ… GitHub sync complete!"

      # -----------------------------
      # Auto-refresh Builder.io
      # -----------------------------
      echo "ğŸ” Triggering Builder.io fetch..."
      BUILDER_PROJECT_API_KEY="YOUR_BUILDER_PROJECT_API_KEY"
      if [ -z "$BUILDER_PROJECT_API_KEY" ]; then
        echo "âŒ Builder.io API key not set. Skipping Builder.io sync."
      else
        curl -X POST "https://builder.io/api/v1/publish/${BUILDER_PROJECT_API_KEY}?branch=main" \
          -H "Content-Type: application/json" \
          -d '{"publish":true}'
        if [ $? -eq 0 ]; then
          echo "âœ… Builder.io fetch triggered!"
        else
          echo "âŒ Failed to trigger Builder.io."
        fi
      fi

      read -p "Press Enter to return to menu..."
      ;;

    6)
      echo "ğŸ” Manual Builder.io sync..."
      read -p "Press Enter to return to menu..."
      ;;

    *)
      echo "âŒ Invalid option. Try again."
      sleep 1
      ;;
  esac
done
