#!/usr/bin/env bash
set -euo pipefail

# === Chefs2Table helper ===
# Minimal menu (Deploy / Ship / Backup / GitHub) — dev & build are hidden shortcuts

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$DIR"

PROJECT_NAME="chefs2u"
DEFAULT_PORT="${PORT:-3002}"   # CRA dev
PAGES_PORT=8788                # Wrangler Pages dev

need() { command -v "$1" >/dev/null 2>&1 || { echo "❌ Missing dependency: $1"; exit 1; }; }
line() { printf '%*s\n' "70" '' | tr ' ' '─'; }
title() { echo; line; echo " $1"; line; }

open_browser() {
  local url="$1"
  if command -v open >/dev/null 2>&1; then open "$url" >/dev/null 2>&1 || true
  elif command -v xdg-open >/dev/null 2>&1; then xdg-open "$url" >/dev/null 2>&1 || true
  fi
}

# --- Hidden actions (not shown in menu) ---
dev_cra() {
  need npm
  title "🧪 Dev (CRA on port $DEFAULT_PORT)"; echo
  export PORT="$DEFAULT_PORT"
  open_browser "http://localhost:$DEFAULT_PORT"
  npm start
}

dev_pages() {
  need wrangler
  title "🧪 Dev (Pages Functions on port $PAGES_PORT)"; echo
  open_browser "http://localhost:$PAGES_PORT"
  wrangler pages dev --compatibility-date=2024-01-01 --port "$PAGES_PORT"
}

build_only() {
  need npm
  title "🛠️  Build: React production bundle"; echo
  npm run build
  echo; echo "✅ Build done."
}

deploy_only() {
  need wrangler
  title "🚀 Deploy: Cloudflare Pages ($PROJECT_NAME)"; echo
  wrangler pages deploy ./build --project-name="$PROJECT_NAME" --commit-dirty=true
  echo "✨ Deployment complete."
}

ship() {
  build_only
  deploy_only
}

backup() {
  need node
  title "💾 Backup"; echo
  node backup.js
}

github_sync() {
  need git
  title "🔄 GitHub Sync"; echo
  # light sanitize, commit if changes
  find . -name "*.lock" -type f -delete || true
  git rm -r --cached backups 2>/dev/null || true
  git rm -r --cached node_modules/.cache 2>/dev/null || true
  git add .
  if ! git diff-index --quiet HEAD; then
    git commit -m "Sync with GitHub: ship updates"
  fi
  git push
}

show_menu() {
  echo
  echo "Pick an option:"
  echo "  1) 🚀  Deploy"
  echo "  2) 📦  Build + Deploy"
  echo "  3) 💾  Backup (node backup.js)"
  echo "  4) 🔄  GitHub Sync"
  echo "  0) ❌  Exit"
  echo
  read -rp "Enter choice: " choice
  echo
}

trap 'echo; echo "↩️  Returning to menu…";' INT

need node
need npm
# wrangler/git required only when used

while true; do
  show_menu
  case "${choice}" in
    1) deploy_only ;;
    2) ship ;;
    3) backup ;;
    4) github_sync ;;
    0) echo "Bye! 👋"; exit 0 ;;

    # --- Hidden shortcuts (not printed) ---
    dev|d|d1) dev_cra ;;         # CRA dev
    pages|d2) dev_pages ;;        # Pages Functions dev
    build|b)  build_only ;;       # build only

    *) echo "❌ Invalid option, try again." ;;
  esac

  echo
  read -rp $'\n↩️  Press ENTER to return to the menu… ' _
done
